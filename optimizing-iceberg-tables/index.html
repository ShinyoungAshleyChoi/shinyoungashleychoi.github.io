<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Developer's Delight</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="shortcut icon" href="/img/favicon.png">
</head>
<body>

<!-- 블로그 제목을 항상 보이게 고정 -->
<header class="site-header">
    <h1 class="site-title">
        Developer's Delight
    </h1>
</header>

<div class="container">
    <div class="sidebar">
    <a href="/" class="logo">
        <img src="/img/favicon.png">
    </a>
    <ul class="nav">
        <div class="nav-inner">
            <li><a href="/about/"><span class="icon info"></span>about</a></li>
            <li><a href="/search/"><span class="icon doc"></span>search</a></li>
            <li><a href="/tags/"><span class="icon code"></span>tags</a></li>
            <li><a href="http://github.com/shinyoungashleychoi"><span class="icon github"></span>github</a></li>
        </div>

    </ul>
</div>
    <div class="wrapper">
        <div class="post">
  <h1 class="post-title">Understanding Apache Iceberg (5) - Optimizing Iceberg tables</h1>
  <div class="post-meta">
    <p>Posted on October 23, 2025</p>
  </div>
  <div class="post-body">
    <p>이번 장에서는 아이스버그 테이블을 최적화 할 수 있는 방법에 대해 알아본다!</p>

<h1 id="compaction">Compaction</h1>
<ul>
  <li>컴팩션은 ‘스몰 파일 문제’를 해결 하기 위해 자잘한 파일을 하나의 파일로 합쳐 IO와 스캔 효율을 높이는 것을 말한다.</li>
  <li>데이터 계층과 메타데이터 계층 모두에 적용 가능</li>
  <li>아래는 데이터 파일에 컴팩션을 적용하는 두 가지 방법
    <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Table</span> <span class="n">table</span> <span class="k">=</span> <span class="nv">catalog</span><span class="o">.</span><span class="py">loadTable</span><span class="o">(</span><span class="s">"myTable"</span><span class="o">);</span>
<span class="nv">SparkActions</span>
<span class="o">.</span><span class="py">get</span><span class="o">()</span>
<span class="o">.</span><span class="py">rewriteDataFiles</span><span class="o">(</span><span class="n">table</span><span class="o">)</span>
<span class="o">.</span><span class="py">sort</span><span class="o">()</span> <span class="c1">// 정렬 전략 사용 (뒤에서 자세히)</span>
<span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="nv">Expressions</span><span class="o">.</span><span class="py">and</span><span class="o">(</span>
  <span class="nv">Expressions</span><span class="o">.</span><span class="py">greaterThanIrEqual</span><span class="o">(</span><span class="s">"date"</span><span class="o">,</span> <span class="s">"2023-01-01"</span><span class="o">),</span> <span class="c1">// 1월 데이터만 필터링</span>
  <span class="nv">Expressions</span><span class="o">.</span><span class="py">lessThanOrEqual</span><span class="o">(</span><span class="s">"date"</span><span class="o">,</span> <span class="s">"2023-01-31"</span><span class="o">)))</span>
<span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"rewrite-job-order"</span><span class="o">,</span> <span class="s">"files-desc"</span><span class="o">)</span> <span class="c1">// 큰 파일 그룹 먼저 컴팩션</span>
<span class="o">.</span><span class="py">execute</span><span class="o">();</span>
<span class="o">))</span>
</code></pre></div>    </div>
  </li>
  <li>아래는 좀 더 쉬운 프로시져를 이용한 방법
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">rewrite_data_files</span><span class="p">(</span>
  <span class="k">table</span> <span class="o">=&gt;</span> <span class="s1">'musicians'</span><span class="p">,</span>
  <span class="n">strategy</span> <span class="o">=&gt;</span> <span class="s1">'binpack'</span><span class="p">,</span>
  <span class="k">where</span> <span class="o">=&gt;</span> <span class="s1">'genre = "rock"'</span>
  <span class="k">options</span> <span class="o">=&gt;</span> <span class="k">map</span><span class="p">(</span>
      <span class="s1">'rewrite-job-order'</span><span class="p">,</span> <span class="s1">'bytes-asc'</span><span class="p">,</span>
      <span class="s1">'target-file-size-bytes'</span><span class="p">,</span> <span class="s1">'1073741824'</span><span class="p">,</span> <span class="c1">-- 1GB</span>
      <span class="s1">'max-file-group-size-bytes'</span><span class="p">,</span> <span class="s1">'10737418240'</span> <span class="c1">--10GB, 하나의 비동기 스파크 태스크에서 총 10GB의 데이터를 처리</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>    </div>
    <h2 id="컴팩션-전략들">컴팩션 전략들</h2>
    <h3 id="binpack">Binpack</h3>
  </li>
  <li>단순 파일만 합치기, 빠름
    <h3 id="sort">Sort</h3>
  </li>
  <li>1개 혹은 여러 개의 필드를 대상으로 순차적으로 정렬</li>
  <li>데이터가 쿼리패턴에 맞춰 클러스터링되므로 읽기 시간 줄어듦</li>
  <li>binpack에 비해 컴팩션에 더 시간 걸림
    <h3 id="z-order">z-order</h3>
  </li>
  <li>여러 필드를 동일한 가중치로 정렬</li>
  <li>쿼리가 여러 필드의 필터링을 한다면 읽기 성능 향상에 도움</li>
  <li>binpack에 비해 컴팩션에 더 시간 걸림</li>
</ul>

<h2 id="스트리밍-데이터를-위한-예제">스트리밍 데이터를 위한 예제</h2>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">rewrite_data_files</span><span class="p">(</span>
    <span class="k">table</span> <span class="o">=&gt;</span> <span class="s1">'streamingtable'</span><span class="p">,</span>
    <span class="n">strategy</span> <span class="o">=&gt;</span> <span class="s1">'binpack'</span><span class="p">,</span> <span class="c1">--빠른 컴팩션을 위해 빈팩 적용</span>
    <span class="k">where</span> <span class="o">=&gt;</span> <span class="s1">'created at between "2023-01-26 09:00:00" and "2023-01-26 09:59:59" '</span><span class="p">,</span> <span class="c1">--한시간 내 데이터에 적용</span>
    <span class="k">options</span> <span class="o">=&gt;</span> <span class="k">map</span><span class="p">(</span>
        <span class="s1">'rewrite-job-order'</span><span class="p">,</span> <span class="s1">'bytes-asc'</span><span class="p">,</span>
        <span class="s1">'target-file-size-bytes'</span><span class="p">,</span> <span class="s1">'1073741824'</span><span class="p">,</span>
        <span class="s1">'max-file-group-size-bytes'</span><span class="p">,</span> <span class="s1">'10737418240'</span><span class="p">,</span>
        <span class="s1">'partial-progress-enabled'</span><span class="p">,</span> <span class="s1">'true'</span> <span class="c1">--파일을 여러 파일그룹으로 나눠 점진적으로하는 컴팩션 허용 (점차적으로 하는 방식)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<h1 id="sorting">Sorting</h1>
<ul>
  <li>sorting 혹은 clustering</li>
  <li>스캔해야할 데이터 파일의 범위를 줄일 수 있다</li>
  <li></li>
</ul>

<h1 id="z-order-1">Z-order</h1>

<h1 id="partitioning">Partitioning</h1>

<h1 id="copy-on-write-vs-merge-on-read">Copy-on-Write vs. Merge-on-Read</h1>

<h1 id="기타-사항">기타 사항</h1>


  </div>
  <div class="post-end-block"></div>
</div>
    </div>
</div>

<script src="/search.js"></script>

</body>
</html>